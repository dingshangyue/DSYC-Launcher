name: Build Android APK
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      upload_artifacts:
        description: 'Whether to upload artifacts'
        required: false
        type: boolean
        default: true
      branch:
        description: 'Git branch to checkout'
        required: false
        type: string
        default: ''

jobs:
  Build-Android:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64-v8a
          - arch: armeabi-v7a
          - arch: x86
          - arch: x86_64

    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref || 'main' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: |
          cd android-app
          # Clean up any existing files
          rm -rf node_modules package-lock.json
          # Create a simple test to verify directory structure
          echo "Current directory: $(pwd)"
          echo "Directory contents: $(ls -la)"
          # Install dependencies with verbose output
          npm install --legacy-peer-deps --verbose
          # Verify installation
          echo "After installation - directory contents: $(ls -la)"
          echo "Node modules exists: $(ls -la node_modules | head -20)"
          # Verify expo is installed
          if [ -d "node_modules/expo" ]; then
            echo "Expo directory exists"
            echo "Expo package.json: $(cat node_modules/expo/package.json | grep version)"
          else
            echo "Expo directory does not exist"
            npm list expo || echo "Expo not found in npm list"
          fi
          # List all installed packages for debugging
          npm list | head -100

      - name: Prebuild Android project
        run: |
          cd android-app
          # Set NODE_PATH for prebuild
          export NODE_PATH=$(pwd)/node_modules
          echo "NODE_PATH set to: $NODE_PATH"
          # Verify expo is available
          if [ -d "node_modules/expo" ]; then
            echo "Expo found, proceeding with prebuild"
          else
            echo "Expo not found, attempting to reinstall"
            npm install expo@~54.0.32 --legacy-peer-deps
          fi
          # Run prebuild with verbose output
          npx expo prebuild --clean --platform android --verbose
          # Verify Android directory was created
          if [ -d "android" ]; then
            echo "Android directory created successfully"
            ls -la android
          else
            echo "ERROR: Android directory not created"
            exit 1
          fi

      - name: Build Android APK
        run: |
          cd android-app
          # Set NODE_PATH to ensure node_modules is found
          export NODE_PATH=$(pwd)/node_modules
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
          
          echo "NODE_PATH set to: $NODE_PATH"
          echo "Current directory: $(pwd)"
          echo "Directory contents: $(ls -la)"
          
          # Verify expo is accessible
          if [ -d "node_modules/expo" ]; then
            echo "Expo found at: $(pwd)/node_modules/expo"
          else
            echo "Expo not found, aborting build"
            exit 1
          fi
          
          # Create a test script to verify module resolution
          cat > test-expo-import.js << 'EOF'
          try {
            require('expo');
            console.log('✓ Successfully imported expo module');
          } catch (error) {
            console.log('✗ Failed to import expo module:', error.message);
            process.exit(1);
          }
          EOF
          
          # Test expo import
          node test-expo-import.js
          
          # Create a custom Metro bundler script
          cat > bundle-android.js << 'EOF'
          const { execSync } = require('child_process');
          const path = require('path');
          
          const projectRoot = path.resolve(__dirname);
          console.log('Bundling from:', projectRoot);
          
          // Set NODE_PATH
          process.env.NODE_PATH = path.join(projectRoot, 'node_modules');
          console.log('NODE_PATH:', process.env.NODE_PATH);
          
          // Run Metro bundler directly
          try {
            console.log('Running Metro bundler...');
            execSync(
              'node node_modules/react-native/cli.js bundle --platform android --dev false --entry-file index.ts --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res/',
              { cwd: projectRoot, stdio: 'inherit' }
            );
            console.log('✓ Bundle created successfully');
          } catch (error) {
            console.error('✗ Bundling failed:', error.message);
            process.exit(1);
          }
          EOF
          
          # Make the script executable
          chmod +x bundle-android.js
          
          # Run the custom bundling script
          echo "Running custom bundling script..."
          node bundle-android.js
          
          # Change to android directory and build
          cd android
          echo "Building from directory: $(pwd)"
          
          # Build APK with increased verbosity, skipping bundling since we already did it
          ./gradlew assembleRelease -x lint -x createBundleReleaseJsAndAssets --info
          
          # Find the generated APK
          find app/build/outputs/apk/release -name "*.apk" -type f

      - name: Setup artifact name
        shell: bash
        run: |
          echo "ARTIFACT_NAME=DSYCLauncher_${{ inputs.version }}_android_${{ matrix.arch }}" >> $GITHUB_ENV

      - name: Prepare and copy artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          ARTIFACT_NAME="${{ env.ARTIFACT_NAME }}"
          
          # Find and copy the APK file
          APK_FILE=$(find android-app/android/app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          
          if [ -n "$APK_FILE" ]; then
            cp "$APK_FILE" "artifacts/${ARTIFACT_NAME}.apk"
            echo "Copied APK: $APK_FILE"
            
            # Calculate SHA256
            SHA256=$(sha256sum "artifacts/${ARTIFACT_NAME}.apk" | awk '{print $1}')
            echo "${SHA256} ${ARTIFACT_NAME}" > "artifacts/${ARTIFACT_NAME}.sha256"
            echo "SHA256: ${SHA256}"
          else
            echo "❌ APK file not found"
            exit 1
          fi

      - name: Upload artifact
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: "artifacts/*"
          if-no-files-found: error
